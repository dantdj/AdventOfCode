This is full of cursed code and only works for part 1. 

I might come back to it at some point, I just don't know the part 2 answer right now.